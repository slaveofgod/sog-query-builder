!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof module&&module.exports?module.exports=e():t.sogqb=e()}(this,function(){!function(){for(var t={},e=["Array","Object","Function","Date","RegExp","Float32Array"],n=0;n<e.length;n++)t["[object "+e[n]+"]"]=e[n].toLowerCase()}();var l={version:"0.0.1",revision:"8bf1a81",config:{stateElementTypes:["expression","conjunction"],expressionOperators:[{key:"equal",label:"Equal"},{key:"not_equal",label:"Not Equal"},{key:"more",label:"More"},{key:"more_or_equal",label:"More or Equal"},{key:"less",label:"Less"},{key:"less_or_equal",label:"less_or_equal"},{key:"like",label:"Like"}],conjunctionOperators:[{key:"or",label:"Or"},{key:"and",label:"And"}],operators:{entity:["equal","not_equal"]}},common:{},themes:{},operatorsList:function(t){for(var e=this.config.operators[t],n=[],i=0;i<e.length;i++)for(var r=0;r<this.config.expressionOperators.length;r++)if(e[i]===this.config.expressionOperators[r].key){n.push({key:this.config.expressionOperators[r].key,label:this.config.expressionOperators[r].label});break}return n},registerTheme:function(e){var t=new[e][0]({},{},!0),n=t.alias;if(void 0===n)throw new Error('The theme has to have "alias" property');if("BaseTheme"!==t.base)throw new Error('The theme has to extend "sogqb.BaseTheme" abstract class');if(void 0===t.__draw)throw new Error('The theme has to implement "__draw" method');if(!1===sogv.isType("string",n)&&!1===sogv.isType("array",n))throw new Error('The alias must be type of "string" or "array", "'+sogv.getType(n)+'" given');"string"==typeof n&&(n=[n]),n.forEach(function(t){void 0===l.themes[e]&&(l.themes[t]=e)})},makeTheme:function(t,e,n,i){if(void 0===l.themes[t])throw new Error('Theme with alias "'+t+'" is not registered.');return new l.themes[t](e,n,i)},makeScheme:function(t){return new l.Scheme(t)},makeState:function(t,e){return new l.State(t,e)},isValidException:function(t,e,n){var i=sogv.isValidWithErrorMessage(e,n);if(null!==i)throw new Error(t+": "+i);return!0},__createHtmlElementFromString:function(t){var e=document.createElement("template");return e.innerHTML=t,e.content.firstChild}};function t(t,e,n){this.__options=t||{},this.__internal=!0===n,(this.__skipDrawing=!1)===this.__internal&&this.__validateOptions(e),this.name="BaseTheme",this.base="BaseTheme"}function e(t){this.__scheme=t||null,this.__validate(),this.name="Scheme"}function n(t,e){this.__state=t||[],this.__scheme=e||[],null!==this.__state&&(this.__validate(),this.__validateFields(),this.__init()),this.name="State"}function i(t,e,n,i,r){var a=this;this.__container=t||null,this.__entity=e||null,this.__scheme=n||null,this.__state=i||null,this.__theme=r||"material",this.initialized=!1,l.isValidException("Container",this.__container,"required|string|length:5,255"),l.isValidException("Entity",this.__entity,"required|string|length:2,50"),this.setScheme(this.__scheme),this.setTheme(this.__theme),this.setState(this.__state,this.__scheme),this.name="Application",window.addEventListener("resize",function(){a.draw()})}function r(t,e,n){l.BaseTheme.call(this,t,{container:e.container||"required|string|length:5,255"},n),this.container=this.__options.container,this.name="MaterialTheme"}return"undefined"!=typeof exports&&(exports.sogqb=l),Object.assign(l,(Object.assign(t.prototype,{appendChild:function(t,e){var n=document.getElementById(this.container),i=this.__buildElement(t,e);n.appendChild(i)},destroy:function(){document.getElementById(this.container).innerHTML=""},draw:function(){this.__beforeDraw(),!1===this.__skipDrawing&&(console.info('Drawing this container with the id "'+this.container+'" ...'),this.__draw(),this.__buildStyleElement(),this.__buildContainerElement(),this.__prettify()),this.__afterDraw()},__draw:function(){throw new Error('The theme has to implement "__draw" method')},__beforeDraw:function(){null===document.getElementById(this.container)&&(this.__skipDrawing=!0,console.info('This container with the id "'+this.container+'" does not exist.'))},__afterDraw:function(){},__validateOptions:function(t){if(null!=t)for(var e in t)t.hasOwnProperty(e)&&l.isValidException("[option: "+e+"]",this.__options[e],t[e])},__prepareCssStyles:function(t){var e={container:this.container};for(var n in e)e.hasOwnProperty(n)&&(t=t.replace(new RegExp("%%"+n+"%%","gm"),e[n]));return t},__buildStyleElement:function(){var t=document.getElementById(this.container),e=document.createElement("style");e.innerHTML=this.__prepareCssStyles(this.cssStyles),t.appendChild(e)},__buildContainerElement:function(){var t=document.getElementById(this.container),e=this.__buildElement("query"),n=this.__buildElement("save"),i=this.__buildElement("search"),r=this.__buildElement("clear");t.appendChild(e),t.appendChild(i),t.appendChild(r),t.appendChild(n)},__prettify:function(){var t=document.getElementById(this.container),e=t.clientWidth;t.childNodes.forEach(function(t){!1===t.classList.contains("query")&&(e-=parseInt(t.clientWidth+3))}),t.querySelector(".query").style.width=e+"px"},__buildElement:function(t,e){var n="";switch(t){case"query":n=this.queryButton.trim();break;case"search":n=this.searchButton.trim();break;case"clear":n=this.clearButton.trim();break;case"save":n=this.saveButton.trim();break;case"field":n=this.fieldButton.trim();break;case"expressionOperator":n=this.expressionOperatorButton.trim();break;case"fieldValue":n=this.fieldValueButton.trim();break;case"conjunctionOperator":n=this.conjunctionOperatorButton.trim()}var i=l.__createHtmlElementFromString(this.__prepareElement(n,e));switch(t){case"search":case"clear":case"save":i.className+=" "+this.cssControlClasses;break;case"field":case"expressionOperator":case"fieldValue":case"conjunctionOperator":i.className+=" "+this.cssQueryClasses}switch(t){case"query":i.classList.add("query-button");break;case"search":i.classList.add("search-button");break;case"clear":i.classList.add("clear-button");break;case"save":i.classList.add("save-button");break;case"field":i.classList.add("field-button");break;case"expressionOperator":i.classList.add("expression-operator-button");break;case"fieldValue":i.classList.add("field-value-button");break;case"conjunctionOperator":i.classList.add("conjunction-operator-button")}return i},__prepareElement:function(t,e){for(var n in e=e||{})e.hasOwnProperty(n)&&(t=t.replace("%%"+n+"%%",e[n]));return t}}),{BaseTheme:t})),Object.assign(l,(e.prototype.constructor=e,Object.defineProperties(e.prototype,{scheme:{get:function(){return this.__scheme}}}),Object.assign(e.prototype,{getEntity:function(t){for(var e=null,n=0;n<this.__scheme.length;n++)if(t===this.__scheme[n].entity){e=this.__scheme[n];break}return e},getEntityColumns:function(t){var e=this.getEntity(t);return null===e?null:e.columns},getEntityColumnsList:function(t){var e=[],n=this.getEntityColumns(t);if(null===n)return e;for(var i=0;i<n.length;i++)e.push({key:t+"."+n[i].name,label:n[i].title});return e},exist:function(t){t=t.split(".");var e=this.getEntity(t[0]);if(null===e)return!1;for(var n=0;n<e.columns.length;n++)if(t[1]===e.columns[n].name)return!0;return!1},getEntityFields:function(t){var e=this.getEntity(t),n=[];if(null===e)return[];for(var i=0;i<e.columns.length;i++)n.push({name:e.columns[i].name,title:e.columns[i].title});return n},getEntityField:function(t){t=t.split(".");for(var e=this.getEntity(t[0]),n=0;n<e.columns.length;n++)if(t[1]===e.columns[n].name)return e.columns[n];return null},getEntityFieldLabel:function(t){return null===(t=this.getEntityField(t))?t:t.title},getEntityFieldType:function(t){return null===(t=this.getEntityField(t))?t:t.type},getEntityFieldFormattedValue:function(t,e){t=t.split(".");for(var n=this.getEntity(t[0]),i=e,r=0;r<n.columns.length;r++)if(t[1]===n.columns[r].name){switch(n.columns[r].type){case"entity":for(var a=0;a<n.columns[r].data.length;a++)if(e===n.columns[r].data[a].id){i=n.columns[r].data[a].label;break}}break}return i},getEntityFieldValueList:function(t){t=t.split(".");for(var e=this.getEntity(t[0]),n=[],i=0;i<e.columns.length;i++)if(t[1]===e.columns[i].name){switch(e.columns[i].type){case"entity":for(var r=0;r<e.columns[i].data.length;r++)n.push({key:e.columns[i].data[r].id,label:e.columns[i].data[r].label})}break}return n},getFormattedExpressionOperator:function(t){var e=l.config.expressionOperators;for(var n in e)if(e.hasOwnProperty(n)&&t===e[n].key){t=e[n].label;break}return t},getFormattedConjunctionOperator:function(t){var e=l.config.conjunctionOperators;for(var n in e)if(e.hasOwnProperty(n)&&t===e[n].key){t=e[n].label;break}return t},__validate:function(){l.isValidException("Scheme",this.__scheme,"required|array|count:1,100");for(var t=0;t<this.__scheme.length;t++)this.__validateEntity(this.__scheme[t].entity),this.__validateColumns(this.__scheme[t].columns);return!0},__validateEntity:function(t){return l.isValidException("Entity",t,"required|string|alpha-dash|length:2,50"),!0},__validateColumns:function(t){return l.isValidException("Columns",t,"required|array|between:1,1000"),t.forEach(function(t){var e=new sogv.Application({lang:"en"}),n={name:t.name,title:t.title,type:t.type,data:t.data},i=e.make(n,{name:"required|string|alpha-dash|length:2,50",title:"required|string|print|length:2,100",type:"required|in:email;integer;numeric;string;date;entity",data:"array"});if(!1===i.isValid())for(var r in n)if(n.hasOwnProperty(r)&&!1===i.get(r).isValid())throw new Error("Column '"+r+"' = '"+n[r]+"': "+i.get(r).errors().first())}),!0}}),{Scheme:e})),Object.assign(l,(n.prototype.constructor=n,Object.defineProperties(n.prototype,{state:{get:function(){return this.__state}}}),Object.assign(n.prototype,{add:function(t,e){e=e||!0,this.__state.push(t),this.__validate(e)},draw:function(t){t.fieldButton,t.fieldValueButton,t.expressionOperatorButton,t.conjunctionOperatorButton;for(var e=0;e<this.__state.length;e++)switch(this.__state[e].type){case"expression":this.__state[e].field.split("."),null!=this.__state[e].field&&t.appendChild("field",{value:this.__state[e].field,label:this.__scheme.getEntityFieldLabel(this.__state[e].field)}),null!=this.__state[e].operator&&t.appendChild("expressionOperator",{value:this.__state[e].operator,label:this.__scheme.getFormattedExpressionOperator(this.__state[e].operator)}),null!=this.__state[e].value&&t.appendChild("fieldValue",{value:this.__state[e].value,label:this.__scheme.getEntityFieldFormattedValue(this.__state[e].field,this.__state[e].value)});break;case"conjunction":t.appendChild("conjunctionOperator",{value:this.__state[e].operator,label:this.__scheme.getFormattedConjunctionOperator(this.__state[e].operator)})}},removeLatestBlock:function(){var t=this.latestBlockIndex();null!==t&&this.__state.splice(t,1)},nextElementType:function(){var t=this.latestBlock();if(null===t||"complete"===t.status&&"conjunction"===t.type)return"field";switch(t.status){case"complete":return"conjunction";case"field":return"operator";case"operator":return"value"}},__init:function(){for(var t=0;t<this.__state.length;t++)this.__state[t].status="complete"},latestBlockIndex:function(){return 0==this.__state.length?null:this.__state.length-1},latestBlock:function(){var t=this.latestBlockIndex();return null===t?null:this.__state[t]},__validate:function(t){t=t||!0,l.isValidException("State",this.__state,"required|array");for(var e=0;e<this.__state.length;e++){l.isValidException("State > Type",this.__state[e].type,"required|alnum|in:"+l.config.stateElementTypes.join(";"));var n=new sogv.Application({lang:"en"}),i={},r={},a=!1===t||"complete"!==this.__state[e].status?"":"required|";switch(this.__state[e].type){case"expression":i={field:this.__state[e].field,value:this.__state[e].value,operator:this.__state[e].operator},r={field:"required|regex:^[a-zA-Z0-9_-]+.[a-zA-Z0-9_-]+$",value:a+"scalar",operator:a+"alnum|in:"+l.config.expressionOperators.map(function(t){return t.key}).join(";")};break;case"conjunction":i={operator:this.__state[e].operator},r={operator:"required|alnum|in:"+l.config.conjunctionOperators.map(function(t){return t.key}).join(";")}}var s=n.make(i,r);if(!1===s.isValid())for(var o in i)if(i.hasOwnProperty(o)&&!1===s.get(o).isValid())throw new Error(sogh.camelCase(this.__state[e].type)+" '"+o+"' = '"+i[o]+"': "+s.get(o).errors().first())}return!0},__validateFields:function(){for(var t=0;t<this.__state.length;t++)if("expression"===this.__state[t].type&&"complete"===this.__state[t].status){var e=this.__state[t].field.split(".");if(!1===this.__scheme.exist(this.__state[t].field))throw new Error('Model "'+e[0]+'" or field "'+e[1]+'" for model "'+e[0]+'" does not exist.')}return!0}}),{State:n})),l.QueryBuilderFactory={create:function(t,e,n){return new function(t,e,n){this.__scheme=t,this.__theme=e,this.__state=n,this.draw=function(){this.__theme.destroy(),this.__state.draw(e),this.__theme.draw()}}(t,e,n)}},Object.assign(l,(i.prototype.constructor=i,Object.defineProperties(i.prototype,{container:{get:function(){return this.__container}},entity:{get:function(){return this.__entity}},scheme:{get:function(){return this.__scheme}},state:{get:function(){return this.__state}},theme:{get:function(){return this.__theme}}}),Object.assign(i.prototype,{setScheme:function(t){this.__scheme=l.makeScheme(t)},setState:function(t,e){void 0!==t&&(e=this.__state),null!==typeof e&&(e=this.__scheme),this.__state=l.makeState(t,e)},setTheme:function(t){this.__theme=l.makeTheme(t,{container:this.container},{})},draw:function(){l.QueryBuilderFactory.create(this.__scheme,this.__theme,this.__state).draw(),this.__init()},__init:function(){var e=this,n=document.querySelector("#"+this.container+" .query-button");null!==document.getElementById(this.container)&&(document.querySelectorAll("#"+this.container+" .field-button").forEach(function(t){t.addEventListener("click",function(t){n.focus()})}),document.querySelectorAll("#"+this.container+" .expression-operator-button").forEach(function(t){t.addEventListener("click",function(t){n.focus()})}),document.querySelectorAll("#"+this.container+" .field-value-button").forEach(function(t){t.addEventListener("click",function(t){n.focus()})}),document.querySelectorAll("#"+this.container+" .conjunction-operator-button").forEach(function(t){t.addEventListener("click",function(t){n.focus()})}),n.addEventListener("focus",function(t){e.__addQueryItem()}),n.addEventListener("keydown",function(t){switch(t.code){case"Backspace":e.__state.removeLatestBlock(),e.draw(),document.querySelector("#"+e.container+" .query-button").focus()}},{passive:!0}),n.addEventListener("blur",function(t){document.querySelector("#"+e.container+" .query-button").innerHTML=""})),this.initialized=!0},__addQueryItem:function(){var n=this,t=this.__state.nextElementType(),e=document.querySelector("#"+this.container+" .query-button");switch(e.innerHTML="",t){case"conjunction":var i=this.__theme.createDropdownElement(l.config.conjunctionOperators,function(t){n.__state.add({type:"conjunction",operator:t.target.getAttribute("data-value"),status:"complete"}),n.draw()},!0);e.appendChild(i);break;case"field":var r=this.__scheme.getEntityColumnsList(this.__entity);i=this.__theme.createDropdownElement(r,function(t){n.__state.add({type:"expression",field:t.target.getAttribute("data-value"),value:null,operator:null,status:"field"},!1),n.draw()},!0),e.appendChild(i);break;case"operator":var a=this.__state.latestBlock(),s=(t=this.__scheme.getEntityFieldType(a.field),l.operatorsList(t));i=this.__theme.createDropdownElement(s,function(t){var e=n.__state.latestBlock();e.operator=t.target.getAttribute("data-value"),e.status="operator",n.draw()},!0),e.appendChild(i);break;case"value":switch(a=this.__state.latestBlock(),t=this.__scheme.getEntityFieldType(a.field)){case"entity":var o=this.__scheme.getEntityFieldValueList(a.field);i=this.__theme.createDropdownElement(o,function(t){var e=n.__state.latestBlock();e.value=n.__scheme.getEntityFieldFormattedValue(e.field,t.target.getAttribute("data-value")),e.status="completed",n.draw()},!0),e.appendChild(i)}}}}),{Application:i})),Object.assign(l,((r.prototype=Object.create(l.BaseTheme.prototype)).constructor=r,Object.defineProperty(r.prototype,"alias",{get:function(){return["material"]}}),Object.defineProperties(r.prototype,{cssStyles:{get:function(){return"#%%container%%{height:36px;border:1px solid #5E5E5E;font-size:16px;}#%%container%% .query{height:34px;float:left;width:10px;padding:4px 0 4px 6px;}#%%container%% button.float-left{margin:3px 0 3px 3px;float:left;}#%%container%% button.float-right{margin:3px 3px 3px 0;float:right;}#%%container%% .btn-group-sm > .btn, .btn-super-sm{padding:3px 10px;font-size:14px;line-height:1.5;border-radius:2px;text-transform:none;}#%%container%% [contentEditable=true]:empty:not(:focus):before{content:attr(data-text);opacity:.5;}"}},cssControlClasses:{get:function(){return"btn btn-default waves-effect btn-super-sm float-right"}},cssQueryClasses:{get:function(){return"btn btn-default btn-icon-text waves-effect btn-super-sm float-left"}},queryButton:{get:function(){return'<div class="query" contentEditable=true data-text="Searching Filter"></div>'}},searchButton:{get:function(){return'<button class="search"><i class="zmdi zmdi-search"></i></button>'}},saveButton:{get:function(){return'<button class="search"><i class="zmdi zmdi-attachment-alt"></i></button>'}},clearButton:{get:function(){return'<button class="clear"><i class="zmdi zmdi-close"></i></button>'}},fieldButton:{get:function(){return'<button class = "bgm-lightgreen" data-value="%%value%%">%%label%%</button>'}},expressionOperatorButton:{get:function(){return'<button class="bgm-lightblue" data-value="%%value%%">%%label%%</button>'}},fieldValueButton:{get:function(){return'<button class="bgm-purple" data-value="%%value%%">%%label%%</button>'}},conjunctionOperatorButton:{get:function(){return'<button class="bgm-black" data-value="%%value%%">%%label%%</button>'}}}),Object.assign(r.prototype,{__draw:function(){},createDropdownElement:function(t,e,n){t=t||[],e=e||function(t){},n=n||!1;var i=document.createElement("div");i.setAttribute("contenteditable",!1),i.classList.add("dropdown");var r=document.createElement("button");r.setAttribute("type","button"),r.setAttribute("class","btn btn-link btn-super-sm waves-effect"),r.setAttribute("data-toggle","dropdown"),r.setAttribute("contenteditable",!1),r.appendChild(document.createTextNode(" "));var a=document.createElement("ul");a.setAttribute("class","dropdown-menu pull-left");for(var s=0;s<t.length;s++){var o=document.createElement("li"),l=document.createElement("a");l.setAttribute("href","#"),l.setAttribute("contenteditable",!1),l.setAttribute("data-value",t[s].key),l.addEventListener("click",e),l.appendChild(document.createTextNode(t[s].label)),o.appendChild(l),a.appendChild(o)}return i.appendChild(r),i.appendChild(a),!1!==n&&setTimeout(function(){i.classList.add("open")},100),i}}),{MaterialTheme:r})),l.registerTheme(l.MaterialTheme),l});